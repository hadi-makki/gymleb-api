# Makefile for Gymleb API Deployment
# Usage: make deploy, make deploy-advanced, make rollback, etc.

.PHONY: help deploy deploy-advanced rollback status logs clean-backup install-deps build dev start stop delete start-pm2 monitor

# ===============================
# Help
# ===============================
help:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ                  Gymleb API - Make Commands                  โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
	@echo "โโโโโโโโโโโโโโโโ Targets โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ  โถ make deploy           โ Simple deployment (pull, install, โ"
	@echo "โ                           build, zero-downtime reload)       โ"
	@echo "โ  โถ make deploy-advanced  โ Deployment with backup + rollback โ"
	@echo "โ  โถ make rollback         โ Rollback to previous working build โ"
	@echo "โ  โถ make status           โ Show PM2 process status            โ"
	@echo "โ  โถ make logs             โ Show recent application logs       โ"
	@echo "โ  โถ make build            โ Build the project only             โ"
	@echo "โ  โถ make install-deps     โ Install dependencies only          โ"
	@echo "โ  โถ make clean-backup     โ Remove backup files                โ"
	@echo "โ  โถ make dev              โ Start dev server                   โ"
	@echo "โ  โถ make start            โ Start production server (Nest)     โ"
	@echo "โ  โถ make stop             โ Stop PM2 process                   โ"
	@echo "โ  โถ make delete           โ Delete PM2 process                 โ"
	@echo "โ  โถ make start-pm2        โ Start PM2 using ecosystem file     โ"
	@echo "โ  โถ make monitor          โ PM2 monitor                        โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"

# ===============================
# Simple deployment (zero-downtime)
# ===============================
deploy:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ ๐ Starting simple deployment for gymleb-api                 โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "๐ฅ Pulling latest changes from git..." && git pull && echo ""
	@echo "๐ฆ Installing dependencies..." && yarn install && echo ""
	@echo "๐จ Building the project..." && yarn build && echo ""
	@echo "๐ Zero-downtime reload via PM2 (wait-ready)..."
	@if pm2 describe gymleb-api > /dev/null 2>&1; then \
		echo "  โช๏ธ  Reloading with updated env (wait-ready)..."; \
		pm2 reload gymleb-api --update-env --wait-ready; \
	else \
		echo "  โ Starting new PM2 process from ecosystem file..."; \
		pm2 start ecosystem.config.js; \
	fi
	@echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ โ Deployment completed successfully!                         โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n"
	@echo "๐ PM2 status:" && pm2 status gymleb-api && echo ""

# ===============================
# Advanced deployment (backup + rollback + zero-downtime)
# ===============================
deploy-advanced:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ ๐ Starting advanced deployment for gymleb-api               โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "๐ฅ Pulling latest changes from git..." && git pull && echo ""
	@echo "๐ฆ Installing dependencies..." && yarn install && echo ""
	@echo "๐พ Creating backup of current working version..."
	@mkdir -p ./backups
	@if [ -d "dist" ]; then \
		tar -czf ./backups/last_working_backup.tar.gz dist/ && \
		echo "  โ Backup created: ./backups/last_working_backup.tar.gz"; \
	else \
		echo "  โ๏ธ  No dist folder found to backup"; \
	fi
	@echo ""
	@echo "๐จ Building the project..." && yarn build && echo ""
	@echo "๐ Zero-downtime reload via PM2 (wait-ready)..."
	@if pm2 describe gymleb-api > /dev/null 2>&1; then \
		echo "  โช๏ธ  Reloading with updated env (wait-ready)..."; \
		pm2 reload gymleb-api --update-env --wait-ready; \
	else \
		echo "  โ Starting new PM2 process from ecosystem file..."; \
		pm2 start ecosystem.config.js; \
	fi
	@echo ""
	@echo "โฑ๏ธ  Waiting for process to stabilize..." && sleep 2 && echo ""
	@if pm2 describe gymleb-api | grep -q "online"; then \
		echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"; \
		echo "โ โ Deployment completed successfully!                     โ"; \
		echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"; \
		echo "\n๐ PM2 status:"; \
		pm2 status gymleb-api; \
		echo "\n๐พ Updating backup with new working version..."; \
		tar -czf ./backups/last_working_backup.tar.gz dist/ && \
		echo "  โ Backup updated successfully!"; \
	else \
		echo "โ PM2 failed to start! Attempting rollback..."; \
		$(MAKE) rollback; \
		exit 1; \
	fi
	@echo ""

# ===============================
# Rollback
# ===============================
rollback:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@echo "โ ๐ Rolling back to previous working version                 โ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
	@if [ -f "./backups/last_working_backup.tar.gz" ]; then \
		echo "๐ฆ Restoring from backup..."; \
		rm -rf dist/; \
		tar -xzf ./backups/last_working_backup.tar.gz; \
		echo "๐ Reloading PM2 (or starting if missing)..."; \
		pm2 reload gymleb-api --update-env --wait-ready || pm2 start ecosystem.config.js; \
		echo "โ Rollback completed successfully!"; \
	else \
		echo "โ No backup found for rollback!"; \
		exit 1; \
	fi
	@echo ""

# ===============================
# Utilities
# ===============================
status:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐ PM2 Status                                              โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@pm2 status gymleb-api && echo ""

logs:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐ Recent logs                                              โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@pm2 logs gymleb-api --lines 50

build:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐จ Building the project                                     โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@yarn build && echo "โ Build completed!\n"

install-deps:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐ฆ Installing dependencies                                  โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@yarn install && echo "โ Dependencies installed!\n"

clean-backup:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐งน Cleaning backup files                                     โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@if [ -f "./backups/last_working_backup.tar.gz" ]; then \
		rm ./backups/last_working_backup.tar.gz && \
		echo "โ Backup file removed!"; \
	else \
		echo "โน๏ธ  No backup file found to remove"; \
	fi
	@echo ""

# ===============================
# Dev / PM2 helpers
# ===============================
dev:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐ Starting development server                               โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@yarn start:dev

start:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐ Starting production server (Nest)                         โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@yarn start:prod

stop:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐ Stopping PM2 process                                      โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@pm2 stop gymleb-api

delete:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐๏ธ  Deleting PM2 process                                     โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@pm2 delete gymleb-api

start-pm2:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐ Starting PM2 process from ecosystem file                  โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@pm2 start ecosystem.config.js

monitor:
	@echo "\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@echo "โ ๐ Opening PM2 monitor                                       โ" && echo ""
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ" && echo ""
	@pm2 monit